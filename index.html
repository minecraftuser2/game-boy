<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Game Boy & NES Emulator Online (with Cheats!)</title>
  <style>
    body { background: #222; color: #fff; text-align: center; }
    #gameboy, #nes { display: none; margin: 20px auto; }
    canvas { box-shadow: 0 0 10px #000; }
    label { font-size: 1.2em; }
    #hint { margin-bottom: 1em; }
    #cheats { margin: 1em auto; width: 320px; background: #333; border-radius: 8px; padding: 1em; display: none; }
    #cheats label { font-size: 1em; }
    #cheats select { width: 200px; }
    #cheats button { margin-left: 0.5em; }
  </style>
  <!-- GameBoy-Online core -->
  <script src="https://unpkg.com/gameboy-online@2.0.0-beta.2/js/GameBoyCore.js"></script>
  <script src="https://unpkg.com/gameboy-online@2.0.0-beta.2/js/GameBoyIO.js"></script>
  <!-- jsnes NES emulator -->
  <script src="https://unpkg.com/jsnes/dist/jsnes.min.js"></script>
</head>
<body>
  <h1>Emulator: Game Boy & NES (with Cheats!)</h1>
  <label for="consoleSelect">Choose Console:</label>
  <select id="consoleSelect">
    <option value="gameboy">Game Boy</option>
    <option value="nes">NES</option>
  </select>
  <br>
  <input type="file" id="romInput" accept=".gb,.nes">
  <p id="hint">
    <b>Instructions:</b><br>
    1. Select NES and upload your legally-owned NES ROM (<code>.nes</code>).<br>
    2. Or select Game Boy and upload a <code>.gb</code> ROM.<br>
    <i>No games are included on this page. Please use your own ROM files.</i>
    <br>
    <b>Controls:</b> Keyboard and controller supported.
    <br>
    <b>Cheats:</b> Use the menu below after loading a ROM!
  </p>
  <div id="cheats">
    <label for="cheatSelect">Apply a cheat:</label>
    <select id="cheatSelect">
      <option value="">-- Select a Cheat --</option>
    </select>
    <button id="applyCheatBtn">Apply</button>
  </div>
  <canvas id="gameboy" width="160" height="144"></canvas>
  <canvas id="nes" width="256" height="240"></canvas>
  <script>
    // Pre-hosted cheats for popular games
    const CHEATS = {
      nes: {
        'Super Mario Bros.': [
          { name: 'Infinite Lives', code: 'SZLIVO' }, // Game Genie
          { name: 'Invincibility (except pits)', code: 'SZNZVZ' }
        ]
      },
      gameboy: {
        'Pokémon Red': [
          { name: 'Infinite Money', code: '019973d5' }, // GameShark
          { name: 'Walk Through Walls', code: '010138cd' }
        ]
      }
    };

    let currentGameTitle = '';
    let currentConsole = 'gameboy';

    // Game Boy setup
    let gameboy = null;
    const gameboyCanvas = document.getElementById('gameboy');
    // NES setup
    let nes = null;
    let nesRunning = false;
    const nesCanvas = document.getElementById('nes');
    const nesCtx = nesCanvas.getContext('2d');
    let nesImageData = nesCtx.getImageData(0, 0, 256, 240);

    const consoleSelect = document.getElementById('consoleSelect');
    const romInput = document.getElementById('romInput');
    const hint = document.getElementById('hint');
    const cheatsDiv = document.getElementById('cheats');
    const cheatSelect = document.getElementById('cheatSelect');
    const applyCheatBtn = document.getElementById('applyCheatBtn');

    function showConsole(consoleName) {
      currentConsole = consoleName;
      gameboyCanvas.style.display = (consoleName === 'gameboy') ? 'block' : 'none';
      nesCanvas.style.display = (consoleName === 'nes') ? 'block' : 'none';
      cheatsDiv.style.display = 'none';
      cheatSelect.innerHTML = `<option value="">-- Select a Cheat --</option>`;
      if (consoleName === 'gameboy') {
        romInput.accept = ".gb";
        hint.innerHTML = `
          <b>Instructions:</b><br>
          1. Select "Game Boy" and upload a <code>.gb</code> ROM file to start playing.<br>
          <i>No games are included on this page. Please use your own ROM files.</i>
          <br>
          <b>Controls:</b> Keyboard and controller supported.
          <br>
          <b>Cheats:</b> Use the menu below after loading a ROM!
        `;
      } else {
        romInput.accept = ".nes";
        hint.innerHTML = `
          <b>Instructions:</b><br>
          1. Select "NES" and upload your legally-owned NES ROM (<code>.nes</code>).<br>
          <i>No games are included on this page. Please use your own ROM files.</i>
          <br>
          <b>Controls:</b> Keyboard and controller supported.
          <br>
          <b>Cheats:</b> Use the menu below after loading a ROM!
        `;
      }
    }

    function startGameBoyEmulator(romBuffer, romName) {
      if (gameboy) gameboy.stop();
      gameboy = new GameBoyCore(gameboyCanvas, romBuffer);
      gameboy.start();
      currentGameTitle = detectGameboyTitle(romBuffer, romName);
      populateCheats();
    }

    // NES rendering and loop
    function nesOnFrame(frameBuffer) {
      for (let i = 0; i < frameBuffer.length; i++) {
        nesImageData.data[i * 4 + 0] = (frameBuffer[i] >> 16) & 0xFF;
        nesImageData.data[i * 4 + 1] = (frameBuffer[i] >> 8) & 0xFF;
        nesImageData.data[i * 4 + 2] = frameBuffer[i] & 0xFF;
        nesImageData.data[i * 4 + 3] = 0xFF;
      }
      nesCtx.putImageData(nesImageData, 0, 0);
    }

    function startNesEmulator(romBuffer, romName) {
      stopNesEmulator();
      nes = new jsnes.NES({
        onFrame: nesOnFrame
      });
      nes.loadROM(Array.prototype.map.call(romBuffer, x => String.fromCharCode(x)).join(""));
      nesRunning = true;
      currentGameTitle = detectNesTitle(romBuffer, romName);
      populateCheats();
      requestAnimationFrame(nesLoop);
    }

    function stopNesEmulator() {
      nesRunning = false;
      nes = null;
    }

    // NES keyboard controls
    const JSNES_CONTROLLER = jsnes.Controller;
    const NES_KEYMAP = {
      88: JSNES_CONTROLLER.BUTTON_A,      // X
      90: JSNES_CONTROLLER.BUTTON_B,      // Z
      13: JSNES_CONTROLLER.BUTTON_START,  // Enter
      16: JSNES_CONTROLLER.BUTTON_SELECT, // Shift
      38: JSNES_CONTROLLER.BUTTON_UP,     // Up
      40: JSNES_CONTROLLER.BUTTON_DOWN,   // Down
      37: JSNES_CONTROLLER.BUTTON_LEFT,   // Left
      39: JSNES_CONTROLLER.BUTTON_RIGHT   // Right
    };

    window.addEventListener("keydown", event => {
      if (!nes) return;
      const key = NES_KEYMAP[event.keyCode];
      if (typeof key !== "undefined") {
        nes.buttonDown(1, key);
        event.preventDefault();
      }
    });
    window.addEventListener("keyup", event => {
      if (!nes) return;
      const key = NES_KEYMAP[event.keyCode];
      if (typeof key !== "undefined") {
        nes.buttonUp(1, key);
        event.preventDefault();
      }
    });

    // Gamepad support (see above for code)

    let lastPadState = {};

    function pollGamepad() {
      const gamepads = navigator.getGamepads ? navigator.getGamepads() : [];
      const gp = gamepads[0];
      if (!gp || !nes) return;

      const mapping = [
        {btn: 0, ctrl: JSNES_CONTROLLER.BUTTON_A},
        {btn: 1, ctrl: JSNES_CONTROLLER.BUTTON_B},
        {btn: 8, ctrl: JSNES_CONTROLLER.BUTTON_SELECT},
        {btn: 9, ctrl: JSNES_CONTROLLER.BUTTON_START},
        {btn: 12, ctrl: JSNES_CONTROLLER.BUTTON_UP},
        {btn: 13, ctrl: JSNES_CONTROLLER.BUTTON_DOWN},
        {btn: 14, ctrl: JSNES_CONTROLLER.BUTTON_LEFT},
        {btn: 15, ctrl: JSNES_CONTROLLER.BUTTON_RIGHT}
      ];

      mapping.forEach(map => {
        const pressed = gp.buttons[map.btn] && gp.buttons[map.btn].pressed;
        if (pressed && !lastPadState[map.btn]) {
          nes.buttonDown(1, map.ctrl);
        } else if (!pressed && lastPadState[map.btn]) {
          nes.buttonUp(1, map.ctrl);
        }
        lastPadState[map.btn] = pressed;
      });
    }

    function nesLoop() {
      if (!nesRunning || !nes) return;
      nes.frame();
      pollGamepad();
      requestAnimationFrame(nesLoop);
    }

    // --- Cheat support logic ---
    function populateCheats() {
      cheatSelect.innerHTML = `<option value="">-- Select a Cheat --</option>`;
      let cheatOptions = [];
      if (currentConsole === 'nes') {
        cheatOptions = CHEATS.nes[currentGameTitle] || [];
      } else if (currentConsole === 'gameboy') {
        cheatOptions = CHEATS.gameboy[currentGameTitle] || [];
      }
      if (cheatOptions.length > 0) {
        cheatOptions.forEach(opt => {
          const el = document.createElement('option');
          el.value = opt.code;
          el.textContent = opt.name + ' (' + opt.code + ')';
          cheatSelect.appendChild(el);
        });
        cheatsDiv.style.display = 'block';
      } else {
        cheatsDiv.style.display = 'none';
      }
    }

    applyCheatBtn.onclick = function() {
      const code = cheatSelect.value;
      if (!code) return;
      if (currentConsole === 'nes' && nes) {
        nes.setGameGenie(code);
        alert('Cheat applied! Restart level if needed.');
      } else if (currentConsole === 'gameboy' && gameboy) {
        gameboy.setCheat(code); // This works in gameboy-online
        alert('Cheat applied! If nothing happens, try reloading the game.');
      }
    };

    // --- ROM title detection for cheats ---
    function detectNesTitle(romBuffer, romName) {
      // Very simple: check filename for Mario, etc.
      if (/mario/i.test(romName)) return 'Super Mario Bros.';
      return '';
    }
    function detectGameboyTitle(romBuffer, romName) {
      if (/pokemon.*red/i.test(romName)) return 'Pokémon Red';
      return '';
    }

    // File handling
    romInput.addEventListener('change', function(e){
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function() {
        const arr = new Uint8Array(reader.result);
        if (consoleSelect.value === 'gameboy') {
          startGameBoyEmulator(arr, file.name);
          stopNesEmulator();
        } else {
          startNesEmulator(arr, file.name);
          if (gameboy) gameboy.stop();
        }
      };
      reader.readAsArrayBuffer(file);
    });

    consoleSelect.addEventListener('change', function() {
      showConsole(consoleSelect.value);
      if (consoleSelect.value === 'gameboy' && nes) stopNesEmulator();
      if (consoleSelect.value === 'nes' && gameboy) gameboy.stop();
    });

    // Initial console setup
    showConsole('gameboy');
  </script>
</body>
</html>
    // Initial console setup
    showConsole('gameboy');
  </script>
</body>
</html>
