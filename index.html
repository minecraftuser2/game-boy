<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Game Boy, NES, & MS-DOS in v86 Emulator Online</title>
  <style>
    body { background: #222; color: #fff; text-align: center; }
    #gameboy, #nes, #v86box { display: none; margin: 20px auto; }
    canvas, .v86-canvas { box-shadow: 0 0 10px #000; }
    label { font-size: 1.2em; }
    #hint { margin-bottom: 1em; }
    #v86status { color: #aaa; margin: 1em; }
  </style>
  <!-- GameBoy-Online core -->
  <script src="https://unpkg.com/gameboy-online@2.0.0-beta.2/js/GameBoyCore.js"></script>
  <script src="https://unpkg.com/gameboy-online@2.0.0-beta.2/js/GameBoyIO.js"></script>
  <!-- jsnes NES emulator -->
  <script src="https://unpkg.com/jsnes/dist/jsnes.min.js"></script>
  <!-- v86 x86 emulator -->
  <script src="https://copy.sh/v86/build/libv86.js"></script>
</head>
<body>
  <h1>Emulator: Game Boy, NES, & MS-DOS (v86)</h1>
  <label for="consoleSelect">Choose Console:</label>
  <select id="consoleSelect">
    <option value="gameboy">Game Boy</option>
    <option value="nes">NES</option>
    <option value="v86">MS-DOS (v86)</option>
  </select>
  <br>
  <input type="file" id="romInput" accept=".gb,.nes">
  <p id="hint">
    <b>Instructions:</b><br>
    - Game Boy: upload <code>.gb</code> ROM.<br>
    - NES: upload <code>.nes</code> ROM.<br>
    - MS-DOS (v86): boots real MS-DOS 6.22; classic command prompt.<br>
    <i>No games are included. Please use your own files.</i><br>
    <b>Controls:</b> Keyboard (Z/X/Enter/Shift/Arrows), controller (NES/GB), mouse/keyboard for MS-DOS.
  </p>
  <canvas id="gameboy" width="160" height="144"></canvas>
  <canvas id="nes" width="256" height="240"></canvas>
  <div id="v86box" style="width:720px; height:400px; margin:auto;">
    <div id="v86status">Loading MS-DOS 6.22 image, please wait...</div>
  </div>
  <script>
    // Game Boy setup
    let gameboy = null;
    const gameboyCanvas = document.getElementById('gameboy');
    // NES setup
    let nes = null;
    let nesRunning = false;
    const nesCanvas = document.getElementById('nes');
    const nesCtx = nesCanvas.getContext('2d');
    let nesImageData = nesCtx.getImageData(0, 0, 256, 240);

    // v86 setup
    let v86 = null;
    const v86Div = document.getElementById('v86box');
    const v86Status = document.getElementById('v86status');
    const V86_BIOS_URL = "https://copy.sh/v86/bios/seabios.bin";
    const V86_VGABIOS_URL = "https://copy.sh/v86/bios/vgabios.bin";
    const V86_HDD_URL = "https://copy.sh/v86/images/msdos622.img";
    const V86_WASM_URL = "https://copy.sh/v86/build/v86.wasm";

    const consoleSelect = document.getElementById('consoleSelect');
    const romInput = document.getElementById('romInput');
    const hint = document.getElementById('hint');

    function showConsole(consoleName) {
      gameboyCanvas.style.display = (consoleName === 'gameboy') ? 'block' : 'none';
      nesCanvas.style.display = (consoleName === 'nes') ? 'block' : 'none';
      v86Div.style.display = (consoleName === 'v86') ? 'block' : 'none';
      if (consoleName === 'gameboy') {
        romInput.accept = ".gb";
        hint.innerHTML = `
          <b>Instructions:</b><br>
          1. Select "Game Boy" and upload a <code>.gb</code> ROM.<br>
          <i>No games are included. Please use your own ROM files.</i>
          <br>
          <b>Controls:</b> Keyboard (Z/X/Enter/Shift/Arrows) and controller supported!
        `;
      } else if (consoleName === 'nes') {
        romInput.accept = ".nes";
        hint.innerHTML = `
          <b>Instructions:</b><br>
          1. Select "NES" and upload your <code>.nes</code> ROM.<br>
          <i>No games are included. Please use your own ROM files.</i>
          <br>
          <b>Controls:</b> Keyboard (Z/X/Enter/Shift/Arrows) and controller supported!
        `;
      } else if (consoleName === 'v86') {
        romInput.accept = ""; // v86 doesn't take file uploads by default here
        hint.innerHTML = `
          <b>Instructions:</b><br>
          1. Select "MS-DOS (v86)" for a real MS-DOS 6.22 PC.<br>
          <i>Click the window and use your keyboard. No games are included.</i><br>
          <b>Controls:</b> Mouse and keyboard, just like a real PC.
        `;
        if (!v86) startV86();
      }
    }

    // Game Boy
    function startGameBoyEmulator(romBuffer) {
      if (gameboy) gameboy.stop();
      if (v86) { v86.stop(); v86 = null; resetV86Box(); }
      gameboy = new GameBoyCore(gameboyCanvas, romBuffer);
      gameboy.start();
    }

    // NES
    function nesOnFrame(frameBuffer) {
      for (let i = 0; i < frameBuffer.length; i++) {
        nesImageData.data[i * 4 + 0] = (frameBuffer[i] >> 16) & 0xFF;
        nesImageData.data[i * 4 + 1] = (frameBuffer[i] >> 8) & 0xFF;
        nesImageData.data[i * 4 + 2] = frameBuffer[i] & 0xFF;
        nesImageData.data[i * 4 + 3] = 0xFF;
      }
      nesCtx.putImageData(nesImageData, 0, 0);
    }
    function startNesEmulator(romBuffer) {
      stopNesEmulator();
      if (v86) { v86.stop(); v86 = null; resetV86Box(); }
      nes = new jsnes.NES({ onFrame: nesOnFrame });
      nes.loadROM(Array.prototype.map.call(romBuffer, x => String.fromCharCode(x)).join(""));
      nesRunning = true;
      requestAnimationFrame(nesLoop);
    }
    function stopNesEmulator() { nesRunning = false; nes = null; }
    function nesLoop() { if (!nesRunning || !nes) return; nes.frame(); requestAnimationFrame(nesLoop); }

    // v86 (MS-DOS) -- helper to clear the div for reboots
    function resetV86Box() {
      v86Div.innerHTML = '<div id="v86status">Loading MS-DOS 6.22 image, please wait...</div>';
    }
    function startV86() {
      resetV86Box();
      v86 = new V86Starter({
        wasm_path: V86_WASM_URL,
        memory_size: 32 * 1024 * 1024,
        vga_memory_size: 2 * 1024 * 1024,
        screen_container: v86Div,
        bios: { url: V86_BIOS_URL },
        vga_bios: { url: V86_VGABIOS_URL },
        hda: { url: V86_HDD_URL },
        autostart: true
      });
      v86.add_listener("emulator-ready", function() {
        v86Status.innerText = "MS-DOS 6.22 is ready! Click the window and use your keyboard.";
      });
      v86.add_listener("download-progress", function(e) {
        if(e.file_name && e.total && e.loaded) {
          v86Status.innerText =
            `Loading ${e.file_name}: ${Math.round(e.loaded/e.total*100)}%`;
        }
      });
    }

    // File handling (GB, NES only)
    romInput.addEventListener('change', function(e){
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function() {
        const arr = new Uint8Array(reader.result);
        if (consoleSelect.value === 'gameboy') {
          startGameBoyEmulator(arr);
          stopNesEmulator();
          if (v86) { v86.stop(); v86 = null; resetV86Box(); }
        } else if (consoleSelect.value === 'nes') {
          startNesEmulator(arr);
          if (gameboy) gameboy.stop();
          if (v86) { v86.stop(); v86 = null; resetV86Box(); }
        }
      };
      reader.readAsArrayBuffer(file);
    });

    // Switch emulator
    consoleSelect.addEventListener('change', function() {
      showConsole(consoleSelect.value);
      if (consoleSelect.value !== 'gameboy' && gameboy) gameboy.stop();
      if (consoleSelect.value !== 'nes') stopNesEmulator();
      if (consoleSelect.value !== 'v86' && v86) { v86.stop(); v86 = null; resetV86Box(); }
    });

    // Initial setup
    showConsole('gameboy');
  </script>
</body>
</html>
